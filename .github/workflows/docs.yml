name: Build and Deploy Documentation

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - '.github/workflows/docs.yml'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '14'

      - name: Debug - Show Node version
        run: |
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "NPM root: $(npm root -g)"

      - name: Install GitBook CLI
        run: |
          echo "Installing GitBook CLI..."
          npm install -g gitbook-cli
          echo "GitBook CLI installed"

      - name: Patch graceful-fs before GitBook install
        run: |
          echo "Patching graceful-fs polyfills..."
          echo "Node version: $(node --version)"
          NODE_VERSION=$(node --version | sed 's/v//')
          echo "Searching for polyfills.js files..."
          
          # Patch all graceful-fs polyfills we can find
          find /opt/hostedtoolcache/node -name "polyfills.js" -path "*/graceful-fs/*" 2>/dev/null | while read file; do
            if [ -f "$file" ]; then
              echo "Patching: $file"
              # Create backup
              cp "$file" "$file.backup" || true
              # Fix the problematic line
              sed -i 's/if (cb) cb\.apply(this, arguments)/if (cb \&\& typeof cb === "function") cb.apply(this, arguments)/g' "$file" || true
              echo "Patched: $file"
            fi
          done
          
          # Also try the npm root location
          if [ -d "$(npm root -g)/gitbook-cli" ]; then
            find "$(npm root -g)/gitbook-cli" -name "polyfills.js" -path "*/graceful-fs/*" 2>/dev/null | while read file; do
              if [ -f "$file" ]; then
                echo "Patching npm root file: $file"
                cp "$file" "$file.backup" || true
                sed -i 's/if (cb) cb\.apply(this, arguments)/if (cb \&\& typeof cb === "function") cb.apply(this, arguments)/g' "$file" || true
              fi
            done
          fi
          
          echo "Finished patching graceful-fs files"

      - name: Install GitBook plugins
        working-directory: docs
        run: |
          echo "Installing GitBook plugins..."
          # Patch on-the-fly if needed during install
          gitbook install 2>&1 | tee /tmp/gitbook-install.log || {
            echo "GitBook install failed, checking logs..."
            cat /tmp/gitbook-install.log
            # Try to patch and retry if error is graceful-fs related
            if grep -q "graceful-fs" /tmp/gitbook-install.log || grep -q "cb.apply" /tmp/gitbook-install.log; then
              echo "Graceful-fs error detected, patching and retrying..."
              find /opt/hostedtoolcache/node -name "polyfills.js" -path "*/graceful-fs/*" -exec sed -i 's/if (cb) cb\.apply(this, arguments)/if (cb \&\& typeof cb === "function") cb.apply(this, arguments)/g' {} \; 2>/dev/null || true
              gitbook install
            else
              exit 1
            fi
          }
          echo "GitBook plugins installed successfully"

      - name: Build GitBook
        working-directory: docs
        run: |
          echo "Building GitBook documentation..."
          gitbook build . _book || {
            echo "GitBook build failed, showing error..."
            exit 1
          }
          echo "GitBook build completed"
          ls -la _book/ | head -10 || echo "Build directory not found"

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'docs/_book'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
